<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    <style>
        body {
          margin: 0;
          font-family: Arial, sans-serif;
          background-color: #1e1e1e;
          color: #f0f0f0;
          height: 100vh;
          display: flex;
          flex-direction: column;
        }

        /* Верхняя панель */
        .top-bar {
          display: flex;
          justify-content: space-between;
          padding: 10px;
          background-color: #2c2c2c;
          border-bottom: 1px solid #444;
        }
        .top-bar input {
          padding: 5px;
          border-radius: 4px;
          border: 1px solid #555;
          background-color: #333;
          color: #f0f0f0;
        }
        .top-bar button {
          padding: 5px 10px;
          margin-left: 5px;
          background-color: #4b8bf4;
          border: none;
          border-radius: 4px;
          color: white;
          cursor: pointer;
        }
        .top-bar button:hover { background-color: #3570d3; }

        /* Сообщение */
        #message { padding: 5px 10px; color: #a0d0ff; min-height: 20px; }

        /* Основной контент */
        .container { display: flex; flex: 1; overflow: hidden; }

        /* Колонка списка файлов */
        .file-list {
          width: 200px;
          background-color: #2a2a2a;
          border-right: 1px solid #444;
          overflow-y: auto;
          padding: 10px;
        }
        .file-list h3 { margin-top: 0; font-size: 16px; }
        .file-item {
          padding: 5px;
          cursor: pointer;
          border-radius: 4px;
        }
        .file-item:hover { background-color: #444; }

        textarea {
          flex: 1;
          padding: 10px;
          background-color: #2a2a2a;
          color: #f0f0f0;
          border: none;
          resize: none;
          font-family: monospace;
          font-size: 14px;
          border-right: 1px solid #444;
          outline: none;
        }
        .preview {
          flex: 1;
          padding: 10px;
          overflow: auto;
        }

        /* Markdown стили */
        .preview h1 { color: #f67; }
        .preview h2 { color: #f97; }
        .preview h3 { color: #fa0; }
        .preview code { background-color: #333; padding: 2px 4px; border-radius: 4px; }
        .preview pre { background-color: #333; padding: 10px; border-radius: 4px; overflow-x: auto; }
        a { color: #4b8bf4; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>

<div class="top-bar">
    <div>
        <input type="text" id="fileName" value="new_file.md" placeholder="Имя файла">
        <button id="saveBtn">Сохранить</button>
    </div>
    <div>
        <input type="number" id="fileId" placeholder="ID файла">
        <button id="loadBtn">Получить</button>
    </div>
</div>

<div id="message"></div>

<div class="container">
    <!-- Список файлов слева -->
    <div class="file-list">
        <h3>Файлы</h3>
        <div id="filesContainer"></div>
    </div>

    <textarea id="editor"># Hello Markdown</textarea>
    <div class="preview" id="preview"></div>
</div>

<script>
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const fileNameInput = document.getElementById('fileName');
    const fileIdInput = document.getElementById('fileId');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');
    const messageEl = document.getElementById('message');
    const filesContainer = document.getElementById('filesContainer');

    function renderMarkdown(md) {
      return md
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2">$1</a>')
        .replace(/\n/g, '<br>');
    }

    function updatePreview() {
      preview.innerHTML = renderMarkdown(editor.value);
    }

    editor.addEventListener('input', updatePreview);
    updatePreview();

    async function fetchFilesList() {
      try {
        const resp = await fetch('/all/1'); // получаем все файлы пользователя id=1
        if (!resp.ok) return;
        const data = await resp.json();
        filesContainer.innerHTML = '';
        data.forEach(f => {
          const div = document.createElement('div');
          div.textContent = f.fileName;
          div.className = 'file-item';
          div.onclick = () => {
            editor.value = f.fileData;
            fileNameInput.value = f.fileName;
            updatePreview();
          };
          filesContainer.appendChild(div);
        });
      } catch (e) {
        console.error(e);
      }
    }

    saveBtn.addEventListener('click', async () => {
      const fileName = fileNameInput.value;
      const fileData = editor.value;
      try {
        const resp = await fetch('/file', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileName, fileData })
        });
        if (resp.ok) {
          messageEl.textContent = 'Сохранено ✅';
          await fetchFilesList(); // обновляем список после сохранения
        } else {
          messageEl.textContent = 'Ошибка сохранения ❌';
        }
      } catch (e) {
        messageEl.textContent = 'Ошибка сети ❌';
      }
    });

    loadBtn.addEventListener('click', async () => {
      const id = fileIdInput.value;
      if (!id) return;
      try {
        const resp = await fetch(`/file/${id}`);
        if (!resp.ok) {
          messageEl.textContent = 'Файл не найден ❌';
          return;
        }
        const data = await resp.json();
        fileNameInput.value = data.fileName;
        editor.value = data.fileData;
        updatePreview();
        messageEl.textContent = 'Файл загружен ✅';
      } catch (e) {
        messageEl.textContent = 'Ошибка сети ❌';
      }
    });

    // Загружаем список при старте
    fetchFilesList();
</script>

</body>
</html>
